var Tetris=function(){"use strict";function t(){var t,i,o,c,h=function(){t.block.replace===!0&&(t.block=new n(t),t.gameField.check_direction(t.block)&&(clearInterval(c),y(),this.init(t.canvas_id))),u.call(this),i.draw(t)},s=function(){if(t.block.x<t.playAreaX-t.block.width()){var e=t.gameField.check_direction(t.block,"r");e||(t.block.x++,i.draw(t))}},d=function(){if(t.block.x>0){var e=t.gameField.check_direction(t.block,"l");e||(t.block.x--,i.draw(t))}},f=function(){t.block.orientation+=90,t.block.orientation>=360&&(t.block.orientation-=360),i.draw(t)},u=function(){t.block.down(),i.draw(t),clearInterval(c),c=setInterval(function(t){return function(){h.call(t)}}(this),b(t.loop_timer,t.level))},b=function(t,e){return t*Math.pow(.95,e)};this.init=function(n){var b=a().debug;t=new e,t.canvas_id=n,i=new r(n),o=new l,document.onkeydown=o.event,c=setInterval(function(t){return function(){h.call(t)}}(this),t.loop_timer),b&&p(),o.add(o.right,s),o.add(o.left,d),o.add(o.up,f),o.add(o.down,function(t){return function(){u.call(t)}}(this)),i.draw(t)};var y=function(){alert("Game over\nYour score is: "+t.score.getScore()+"\nPress ok to start a new game")},p=function(){var e,i,o,n,r=document.createElement("table"),l=document.createElement("tbody");for(o=0;o<t.playAreaY;o++){for(e=document.createElement("tr"),n=0;n<t.playAreaX;n++)i=document.createElement("td"),i.appendChild(document.createTextNode(n+","+o)),i.style.width="21",i.style.height="23",e.appendChild(i);l.appendChild(e)}r.style.position="absolute",r.style.fontSize="10px",r.appendChild(l),document.getElementById("debug_grid").appendChild(r)}}function e(){this.available_layouts=[[[0,1,0],[1,1,1]],[[0,0,1],[1,1,1]],[[1,0,0],[1,1,1]],[[0,1,1],[1,1,0]],[[1,1,0],[0,1,1]],[[1],[1],[1],[1]],[[1,1],[1,1]]],this.layout_colors=["rgb(255, 0, 0)","rgb(255, 255, 0)","rgb(255, 0, 255)","rgb(127, 0, 0)","rgb(127, 127, 0)","rgb(127, 0, 127)","rgb(127, 127, 127)"],this.playAreaX=22,this.playAreaY=40,this.blockSize=15,this.block=new n(this),this.gameField=new o(this),this.score=new i,this.loop_timer=1e3,this.removed_lines=0,this.level=0,this.canvas_id=""}function i(){var t=0,e=1e3,i=!0;this.removed_lines=function(o){var n=o*e;i&&(n*=o),t+=n},this.draw=function(){var e=document.getElementById("score");null!==e&&(e.innerHTML=t)},this.getScore=function(){return t}}function o(t){var e,i,o=t,n=[];for(e=0;e<o.playAreaX;e++)for(n[e]=[],i=0;i<o.playAreaY;i++)n[e][i]=!1;this.draw=function(t){var e,i,r;for(t.fillStyle="rgb(44, 44, 44)",t.fillRect(0,0,o.playAreaX*o.blockSize,o.playAreaY*o.blockSize),t.fillStyle="rgba(44, 44, 44, 0.3)",e=0;e<o.playAreaX*o.blockSize;e+=2*o.blockSize)t.fillRect(e,0,o.blockSize,o.playAreaY*o.blockSize);for(t.fillStyle="rgb(255, 255, 0)",i=0;i<o.playAreaX;i++)for(r=0;r<o.playAreaY;r++)n[i][r]===!0&&t.fillRect(i*o.blockSize+1,r*o.blockSize+1,o.blockSize-2,o.blockSize-2)},this.check_direction=function(t,e){var i,r,l,a,c=!1,h={x:0,y:0};for(i=0;i<t.width()*t.height();i++){switch(l=o.block.x+h.x,a=o.block.y+h.y,e){case"u":a--;break;case"r":l++;break;case"d":a++;break;case"l":l--}if(n[l][a]&&(r=t.piece_filled(i))){c=!0;break}h=t.update_render_offsets(h)}return c},this.check_hit_bottom=function(t){var e,i,o,r,l,a=this.check_direction(t,"d");if(t.y+t.height()>=n[0].length&&(a=!0),a){for(t.replace=!0,e={x:0,y:0},r=0;r<t.width()*t.height();r++)i=t.x+e.x,o=t.y+e.y,l=t.piece_filled(r),l&&(n[i][o]=!0),e=t.update_render_offsets(e);this.check_for_full_lines()}},this.check_for_full_lines=function(){var t,e,i,r=0;for(t=0;t<n[0].length;t++){for(i=0,e=0;e<n.length;e++)n[e][t]&&i++;if(i===n.length)for(r++,e=0;e<n.length;e++)n[e].splice(t,1),n[e].unshift(!1)}r>0&&o.score.removed_lines(r),o.level+=.1*r}}function n(t){this.type=Math.ceil(7*Math.random())-1,this.color=t.layout_colors[this.type],this.orientation=0;var e=t.available_layouts[this.type];this.height=function(){return 0===this.orientation||180===this.orientation?e.length:e[0].length},this.width=function(){return 90===this.orientation||270===this.orientation?e.length:e[0].length},this.x=Math.floor(t.playAreaX/2-this.width()/2),this.y=0,this.draw=function(e){e.fillStyle=this.color;var i,o,n,r,l={x:0,y:0};for(i=0;i<this.width()*this.height();i++)o=this.piece_filled(i),o&&(n=(this.x+l.x)*t.blockSize,r=(this.y+l.y)*t.blockSize,e.fillRect(n+1,r+1,t.blockSize-2,t.blockSize-2)),l=this.update_render_offsets(l)},this.update_render_offsets=function(t){return t.x++,t.x>=this.width()&&(t.y++,t.x=0),t},this.piece_filled=function(t){var i=this.step_to_rotated_coordinates(t),o=e[i.y][i.x];return!!o},this.step_to_coordinates=function(t){var e={x:0,y:0};return 0===this.orientation||180===this.orientation?(e.x=t%this.width(),e.y=Math.floor(t/this.width())):(e.x=Math.floor(t/this.width()),e.y=(t+1)%this.width()),e},this.step_to_rotated_coordinates=function(t){var e=this.step_to_coordinates(t);return 180===this.orientation?(e.x=this.width()-e.x-1,e.y=this.height()-e.y-1):270===this.orientation&&(e.x=this.width()-e.x,6===this.type&&e.x--,4===this.width()&&(e.x-=4),e.y=this.width()-e.y-1),e},this.down=function(){t.gameField.check_hit_bottom(t.block,"d"),t.block.replace!==!0&&(this.y+=1)}}function r(t){this.draw=function(e){var i=document.getElementById(t),o=i.getContext("2d");e.gameField.draw(o),e.block.draw(o),e.score.draw()}}function l(){this.up=38,this.right=39,this.left=37,this.down=40;var t={};this.add=function(e,i){t[e]=i},this.event=function(e){void 0!==t[e.keyCode]&&t[e.keyCode]()}}function a(){var t={};return window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,i,o){t[i]=o}),t}return new t}();